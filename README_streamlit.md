# 🏥 医学图像AI诊断系统 - Streamlit Web界面

基于GLM-4V多模态大模型的医学图像智能诊断系统，提供现代化的Web用户界面。

## ✨ 功能特点

### 🖼️ 图像处理能力
- **多格式支持**：JPG、JPEG、PNG、BMP、TIFF、WebP
- **智能验证**：自动验证文件格式和大小（限制10MB）
- **实时预览**：上传后即时显示图像信息

### 🤖 AI诊断功能
- **专业模型**：基于GLM-4V-9B-Thinking模型
- **医学专业**：专门针对医学图像阅片优化
- **流式输出**：实时显示AI分析过程
- **自定义提示**：可配置诊断提示词

### 📊 批量处理
- **多文件上传**：同时处理多张医学图像
- **进度跟踪**：实时显示处理进度
- **批量报告**：生成综合分析报告

### 💾 结果管理
- **历史记录**：保存所有分析历史
- **报告下载**：支持单个和批量报告下载
- **统计信息**：显示分析成功率和性能指标

## 🚀 快速开始

### 1. 环境准备

确保在transformers conda环境中运行：
```bash
conda activate transformers
```

### 2. 安装依赖
```bash
pip install -r requirements.txt
```

### 3. 启动应用

#### 方式一：使用启动脚本（推荐）
```bash
python run_app.py
```

#### 方式二：直接启动Streamlit
```bash
streamlit run streamlit_app.py
```

### 4. 访问应用
应用启动后会自动打开浏览器，或手动访问：
- 本地地址：http://localhost:8501

## 📱 界面说明

### 🎛️ 侧边栏
- **系统信息**：显示GPU/CPU设备信息
- **模型管理**：加载/重载GLM-4V模型
- **分析配置**：自定义提示词和参数

### 📋 主界面标签页

#### 1. 🖼️ 单张图像分析
- 上传单张医学图像
- 实时预览图像和信息
- 一键AI诊断分析
- 流式显示分析结果
- 下载诊断报告

#### 2. 📊 批量处理
- 同时上传多张图像
- 批量AI诊断分析
- 实时进度跟踪
- 批量结果展示
- 综合报告下载

#### 3. 📋 历史结果
- 查看所有分析历史
- 统计分析成功率
- 重新下载历史报告
- 清空历史记录

## ⚙️ 系统要求

### 硬件要求
- **GPU**：推荐NVIDIA RTX系列（支持CUDA）
- **内存**：建议16GB以上
- **存储**：模型文件约18GB空间

### 软件要求
- **Python**：3.8+
- **CUDA**：11.8+ (用于GPU加速)
- **Conda**：建议使用conda管理环境

## 🔧 配置选项

### 模型配置
- **模型路径**：`ZhipuAI/GLM-4.1V-9B-Thinking`
- **设备映射**：自动检测CUDA设备
- **数据类型**：bfloat16（优化显存使用）

### 生成参数
- **最大token数**：1000-8192（可调节）
- **温度**：0.8（平衡创造性和准确性）
- **Top-p**：0.9（核采样参数）

## 📊 性能指标

### 处理速度
- **单张图像**：通常30-80秒（取决于图像复杂度）
- **GPU加速**：相比CPU快5-10倍
- **批量处理**：支持并发优化

### 资源使用
- **显存占用**：约12-16GB（GLM-4V-9B模型）
- **内存占用**：约4-8GB
- **存储空间**：模型文件约18GB

## 🛠️ 故障排除

### 常见问题

#### 1. 模型加载失败
- 确保网络连接正常（首次下载模型）
- 检查CUDA环境是否正确安装
- 确认显存是否足够（需要16GB+）

#### 2. 图像上传失败
- 检查文件格式是否支持
- 确认文件大小不超过10MB
- 验证图像文件是否完整

#### 3. 分析速度慢
- 确认使用GPU而非CPU
- 检查显存是否充足
- 考虑降低max_tokens参数

### 环境检查
```bash
# 检查CUDA可用性
python check_cuda.py

# 检查依赖包
pip list | grep -E "(streamlit|torch|transformers|modelscope)"
```

## 📈 使用建议

### 最佳实践
1. **首次使用**：先加载模型，等待加载完成
2. **图像质量**：使用清晰、高分辨率的医学图像
3. **提示词**：根据具体检查类型调整诊断提示词
4. **批量处理**：对于多张图像，使用批量功能更高效

### 注意事项
- 此系统仅供研究和辅助诊断使用
- 实际医学诊断需要专业医生确认
- 保护患者隐私，不要上传敏感医学数据
- 定期清理历史记录以释放存储空间

## 🔄 版本更新

当前版本：v1.0.0
- ✅ 基础图像分析功能
- ✅ 批量处理支持
- ✅ 现代化Web界面
- ✅ 结果管理系统

## 📞 技术支持

如有问题或建议，请检查：
1. 环境配置是否正确
2. 依赖包是否完整安装
3. GPU驱动和CUDA是否正常
4. 模型文件是否完整下载

---

**⚠️ 免责声明**：此系统仅供研究和教育用途，不能替代专业医学诊断。任何医学决策都应咨询专业医疗人员。
